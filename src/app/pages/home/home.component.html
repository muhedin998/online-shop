<!-- Filters -->
<section class="mb-4">
  <div class="flex gap-2 overflow-x-auto pb-1">
    <button (click)="selectedCategoryId.set(null)"
            class="px-3 py-1.5 rounded-full text-sm border transition whitespace-nowrap"
            [ngClass]="selectedCategoryId() === null ? 'bg-brand-600 text-white border-transparent' : 'bg-gray-100 border-gray-300 hover:bg-gray-200'">
      Sve
    </button>
    <button *ngFor="let c of categories()" (click)="selectedCategoryId.set(c.id)"
            class="px-3 py-1.5 rounded-full text-sm border transition whitespace-nowrap"
            [ngClass]="selectedCategoryId() === c.id ? 'bg-brand-600 text-white border-transparent' : 'bg-gray-100 border-gray-300 hover:bg-gray-200'">
      {{ c.name }}
    </button>
  </div>
  </section>

  <!-- Advanced filters from backend reference -->
  <section class="mb-4 bg-white p-3 rounded-xl shadow-sm">
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 text-sm items-center">
      <div class="col-span-2">
        <label class="block text-gray-500 text-xs mb-1">Cena (min)</label>
        <input type="number" class="w-full border rounded p-1" [ngModel]="minPrice()" (ngModelChange)="setMinPrice($event)" />
      </div>
      <div class="col-span-2">
        <label class="block text-gray-500 text-xs mb-1">Cena (max)</label>
        <input type="number" class="w-full border rounded p-1" [ngModel]="maxPrice()" (ngModelChange)="setMaxPrice($event)" />
      </div>
      <div>
        <label class="block text-gray-500 text-xs mb-1">Na stanju</label>
        <div class="flex gap-1">
          <button class="px-2 py-1 rounded border" [class.bg-brand-600]="inStock()===true" [class.text-white]="inStock()===true" (click)="setInStock(true)">Da</button>
          <button class="px-2 py-1 rounded border" [class.bg-brand-600]="inStock()===false" [class.text-white]="inStock()===false" (click)="setInStock(false)">Ne</button>
          <button class="px-2 py-1 rounded border" (click)="clearInStock()">Sve</button>
        </div>
      </div>
      <div>
        <label class="block text-gray-500 text-xs mb-1">Istaknuti</label>
        <div class="flex gap-1">
          <button class="px-2 py-1 rounded border" [class.bg-brand-600]="featured()===true" [class.text-white]="featured()===true" (click)="setFeatured(true)">Da</button>
          <button class="px-2 py-1 rounded border" [class.bg-brand-600]="featured()===false" [class.text-white]="featured()===false" (click)="setFeatured(false)">Ne</button>
          <button class="px-2 py-1 rounded border" (click)="clearFeatured()">Sve</button>
        </div>
      </div>
      <div class="col-span-2 lg:col-span-1">
        <label class="block text-gray-500 text-xs mb-1">Sortiraj</label>
        <div class="flex gap-1">
          <select class="border rounded p-1" [ngModel]="sortKey()" (ngModelChange)="setSortKey($event)">
            <option value="name">Naziv</option>
            <option value="price">Cena</option>
            <option value="id">ID</option>
          </select>
          <select class="border rounded p-1" [ngModel]="sortDir()" (ngModelChange)="setSortDir($event)">
            <option value="asc">ASC</option>
            <option value="desc">DESC</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h3 class="font-semibold text-lg mb-3">Najprodavanije</h3>
    <div *ngIf="loading()" class="text-sm text-gray-500 mb-2">Učitavanje...</div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      <app-product-card
        *ngFor="let p of visible()"
        [product]="p"
        [isFavorite]="isFav(p.id)"
        (add)="addToCart($event)"
        (toggleFavorite)="toggleFav($event)"
        (view)="openDetail($event)">
      </app-product-card>
    </div>
    <div *ngIf="!visible().length" class="mt-6 text-center text-gray-500">
      Nema rezultata.
    </div>
    <!-- Pagination -->
    <div *ngIf="totalPages()>1" class="mt-4 flex items-center justify-center gap-2 text-sm flex-wrap">
      <button (click)="firstPage()" class="px-3 py-1.5 rounded border" [disabled]="pageIndex()===0">Prva</button>
      <button (click)="prevPage()" class="px-3 py-1.5 rounded border" [disabled]="pageIndex()===0">Prethodna</button>
      <span>Strana</span>
      <input type="number" class="w-16 border rounded p-1 text-center" [ngModel]="pageIndex()+1" (ngModelChange)="jumpTo($event)" />
      <span>od {{ totalPages() }}</span>
      <button (click)="nextPage()" class="px-3 py-1.5 rounded border" [disabled]="pageIndex()+1>=totalPages()">Sledeća</button>
      <button (click)="lastPage()" class="px-3 py-1.5 rounded border" [disabled]="pageIndex()+1>=totalPages()">Poslednja</button>
      <span class="ml-4 text-gray-500">Prikaži</span>
      <select [ngModel]="pageSize()" (ngModelChange)="setSize($event)" class="border rounded p-1">
        <option [ngValue]="6">6</option>
        <option [ngValue]="12">12</option>
        <option [ngValue]="24">24</option>
      </select>
      <span class="text-gray-500">po strani</span>
      <span class="ml-2 text-gray-400">Ukupno: {{ totalElements() }}</span>
    </div>
  </section>

  <!-- Product Detail Modal -->
  <div *ngIf="selected" class="fixed inset-0 z-50 flex items-center justify-center">
    <!-- Backdrop -->
    <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" (click)="closeDetail()"></div>

    <!-- Sheet/Modal -->
    <div class="relative w-full sm:max-w-lg mx-4 bg-white rounded-2xl shadow-xl animate__animated animate__fadeInUp overflow-hidden max-h-[90vh] flex flex-col" role="dialog" aria-modal="true" aria-labelledby="detail-title">
      <!-- Close button -->
      <button (click)="closeDetail()" class="absolute top-3 right-3 z-10 rounded-full bg-black/70 text-white p-2 hover:bg-black/80" aria-label="Zatvori detalje">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M6.225 4.811a1 1 0 0 1 1.414 0L12 9.172l4.361-4.361a1 1 0 1 1 1.414 1.414L13.414 10.586l4.361 4.361a1 1 0 0 1-1.414 1.414L12 12l-4.361 4.361a1 1 0 0 1-1.414-1.414l4.361-4.361-4.361-4.361a1 1 0 0 1 0-1.414Z"/></svg>
      </button>

      <!-- Gallery -->
      <div class="relative">
        <div class="overflow-hidden" (pointerdown)="onPointerDown($event)" (pointermove)="onPointerMove($event)" (pointerup)="onPointerUp($event)" (pointercancel)="onPointerUp($event)">
          <div class="flex" [style.transform]="'translateX(calc(-' + (currentIndex * 100) + '% + ' + (dragging ? deltaX : 0) + 'px))'" [style.transition]="dragging ? 'none' : 'transform 0.3s ease-out'">
            <ng-container *ngFor="let img of gallery; index as i">
              <div class="min-w-full relative">
                <img [src]="img" [alt]="selected?.name + ' slika ' + (i+1)" class="h-72 w-full object-cover bg-gray-100" (error)="onImgError($event)" />
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Nav arrows -->
        <button (click)="$event.stopPropagation(); prev()" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 rounded-full p-2 shadow-md">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M15.75 19.5 8.25 12l7.5-7.5"/></svg>
        </button>
        <button (click)="$event.stopPropagation(); next()" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-gray-800 rounded-full p-2 shadow-md">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="m8.25 4.5 7.5 7.5-7.5 7.5"/></svg>
        </button>

        <!-- Dots -->
        <div class="absolute bottom-2 inset-x-0 flex justify-center gap-1">
          <button
            *ngFor="let _ of gallery; index as i"
            (click)="go(i)"
            class="h-1.5 rounded-full transition-all"
            [ngClass]="{ 'bg-white': i === currentIndex, 'bg-white/50': i !== currentIndex }"
            [style.width.px]="i === currentIndex ? 16 : 6"
            [attr.aria-label]="'Idi na sliku ' + (i + 1)">
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="p-4">
        <h3 id="detail-title" class="text-lg font-bold text-gray-900">{{ selected?.name }}</h3>
        <div class="mt-1 flex items-center justify-between">
          <div class="text-brand-700 text-xl font-extrabold">{{ selected?.price | currency:'RSD':'symbol':'1.0-0':'sr-RS' }}</div>
          <div *ngIf="selected?.volume" class="text-xs text-gray-500">{{ selected?.volume }}</div>
        </div>
        <div *ngIf="selected?.tags?.length" class="mt-2 flex flex-wrap gap-1">
          <span *ngFor="let t of selected?.tags" class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-700">#{{ t }}</span>
        </div>
        <p class="mt-3 text-sm text-gray-700 whitespace-pre-line">{{ selected?.longDescription || selected?.description }}</p>

        <app-review-form [productId]="selected?.id"></app-review-form>

        <div class="mt-4 flex items-center gap-3">
          <button (click)="addToCart(selected!)" class="flex-1 px-4 py-3 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-semibold active:scale-95 transition">Dodaj u korpu</button>
          <button (click)="closeDetail()" class="px-4 py-3 rounded-xl bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium">Zatvori</button>
        </div>
      </div>
    </div>
  </div>
